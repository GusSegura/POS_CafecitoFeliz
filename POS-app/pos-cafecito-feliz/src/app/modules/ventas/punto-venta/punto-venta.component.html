<div class="container-fluid py-4">
  <div class="row align-items-start mb-4 g-3">

    <div class="col-12 col-md-3">
      <h2 class="mb-0">
        <i class="bi bi-cart-check"></i> Punto de Venta
      </h2>
      <p class="text-muted mb-0">Sistema de ventas con descuentos</p>
    </div>

    <div class="col-12 col-md-6 d-flex justify-content-center">
    <div class="d-flex gap-2 w-100 justify-content-center">

        <button
        (click)="filtrarPorCategoria('todos')"
        class="btn btn-outline-primary pos-category-btn flex-fill">
        <i class="bi bi-grid-3x3-gap fs-4 mb-1"></i>
        <span class="small fw-semibold">Todos</span>
      </button>

      <button
        (click)="filtrarPorCategoria('café')"
        class="btn btn-outline-success pos-category-btn flex-fill">
        <i class="bi bi-cup-hot fs-4 mb-1"></i>
        <span class="small fw-semibold">Cafés</span>
      </button>

      <button
        (click)="filtrarPorCategoria('bebida')"
        class="btn btn-outline-warning pos-category-btn flex-fill">
        <i class="bi bi-cup-straw fs-4 mb-1"></i>
        <span class="small fw-semibold">Bebidas</span>
      </button>

      <button
        (click)="filtrarPorCategoria('alimento')"
        class="btn btn-outline-info pos-category-btn flex-fill">
        <i class="bi bi-fork-knife fs-4 mb-1"></i>
        <span class="small fw-semibold">Alimentos</span>
      </button>

      <button
        (click)="filtrarPorCategoria('postre')"
        class="btn btn-outline-secondary pos-category-btn flex-fill">
        <i class="bi bi-cake2 fs-4 mb-1"></i>
        <span class="small fw-semibold">Postres</span>
      </button>


      </div>
    </div>

    <!-- CLIENTE -->
    <div class="col-12 col-md-3">
      <div class="bg-white border rounded p-3 shadow-sm h-100">

        <label class="form-label small fw-bold mb-1">
          Búsqueda de cliente
        </label>

        <form (ngSubmit)="buscarCliente()">
          <div class="input-group input-group-sm">

            <input
              type="text"
              class="form-control"
              placeholder="Buscar cliente..."
              [(ngModel)]="busquedaCliente"
              name="busquedaCliente">

          </div>
        </form>
            @if (clienteSeleccionado) {
            <div class="mt-2 alert alert-info py-1 px-2 small mb-0 d-flex justify-content-between align-items-center">
              <span>
                <i class="bi bi-person-check"></i> {{ clienteSeleccionado.nombre }}
                <span class="badge bg-warning text-dark ms-2">
                  -{{ calcularDescuento(clienteSeleccionado.purchasesCount) }}%
                </span>
              </span>
              <button type="button" class="btn-close" style="font-size: 0.5rem;" (click)="clienteSeleccionado = null"></button>
            </div>
            }
      </div>
    </div>
  </div>

  <div class="row g-3">

    <!-- PRODUCTOS -->
    <div class="col-12 col-md-9">
      <div class="bg-light rounded p-3 h-100">

        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">

          @for (prod of productosFiltrados; track prod._id) {
            <div class="col">
              <div
                class="card producto-card border-0 shadow-sm h-100"
                (click)="agregarAlCarrito(prod)">

                <div class="card-img-container">
                  <img
                    [src]="getImageUrl(prod.imagen)"
                    class="card-img-top"
                    alt="{{ prod.nombre }}">
                </div>

                <div class="card-body d-flex flex-column justify-content-between">

                  <div>
                    <h6 class="card-title fw-bold mb-0 text-truncate">
                      {{ prod.nombre }}
                    </h6>
                    <small class="text-muted">
                      {{ prod.categoria | titlecase }}
                    </small>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <span class="fw-bold text-primary">
                      ${{ prod.precio | number:'1.2-2' }}
                    </span>

                    <span
                      class="badge"
                      [ngClass]="prod.stock > 5
                        ? 'bg-success-subtle text-success'
                        : 'bg-danger-subtle text-danger'">
                      Stock: {{ prod.stock }}
                    </span>
                  </div>

                </div>

              </div>
            </div>
          }

          </div>

        </div>

      </div>
    

    <!-- CARRITO -->
    <div class="col-12 col-md-3">
      <div class="bg-white border rounded d-flex flex-column shadow-sm pos-cart">

        <!-- LISTA (SCROLL) -->
        <div class="pos-cart-items flex-grow-1 overflow-auto p-2">
          <ul class="list-group list-group-flush">

            @for (item of carrito; track item.producto._id) {
              <li
                class="list-group-item px-0 d-flex justify-content-between align-items-center">

                <div class="me-auto">
                  <div class="fw-bold small">
                    {{ item.producto.nombre }}
                  </div>
                  <div class="text-muted small">
                    ${{ item.producto.precio }} x {{ item.cantidad }}
                  </div>
                </div>

                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary py-0" (click)="decrementar(item)">-</button>
                  <button class="btn btn-outline-secondary py-0" disabled>{{ item.cantidad }}</button>
                  <button class="btn btn-outline-secondary py-0" (click)="incrementar(item)">+</button>
                </div>

              </li>
            }


          </ul>
        </div>

        <!-- FOOTER FIJO -->
        <div class="pos-cart-footer p-3 border-top bg-light">

          <div class="d-flex justify-content-between mb-1 small">
            <span>Subtotal:</span>
            <span>${{ subtotal | number:'1.2-2' }}</span>
          </div>

          @if (descuento > 0) {
            <div class="d-flex justify-content-between mb-2 text-success small">
              <span>Descuento ({{ descuento }}%):</span>
              <span>- ${{ montoDescuento | number:'1.2-2' }}</span>
            </div>
          }


          <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
            <span>Total:</span>
            <span>${{ total | number:'1.2-2' }}</span>
          </div>

            <label class="form-label fw-semibold small">Método de pago</label>
            <div class="mb-3">
              <div class="btn-group w-100">
                <button
                  type="button"
                  class="btn"
                  [class.btn-outline-secondary]="metodoPago !== 'efectivo'"
                  [class.btn-secondary]="metodoPago === 'efectivo'"
                  (click)="seleccionarMetodo('efectivo')">
                  <i class="bi bi-cash-coin"></i> Efectivo
                </button>

                <button
                  type="button"
                  class="btn"
                  [class.btn-outline-primary]="metodoPago !== 'tarjeta'"
                  [class.btn-primary]="metodoPago === 'tarjeta'"
                  (click)="seleccionarMetodo('tarjeta')">
                  <i class="bi bi-credit-card"></i> Tarjeta
                </button>
              </div>
            </div>
            <button class="btn btn-success w-100 py-2 fw-bold text-uppercase shadow-sm" 
              (click)="procesarVenta()" 
              [disabled]="carrito.length === 0"> 
              <i class="bi bi-cash-coin me-2"></i> Cobrar 
            </button>
        </div>

      </div>
    </div>
  </div>
  </div>
